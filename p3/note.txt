FUN_140001ea0
"expand 32-byte k" 채우고

key 24B 복사하고

+0x2e = 46 = key 마지막 short?

FUN_140001070
뭔가 체크하고
FUN_140001ea0 불러서 "expand" 채우고
local_58에 rand()로 뭔가 세팅한 뒤
FUN_1400020f0를 불러서 expand 다음 부분을 채움

FUN_1400020f0 (chacha20_block_set_counter로 추정됨)
block[14] = counter
block[15] = counter >> 32

FUN_140001070
chacha20 context setting 함수로 추정됨
FUN_140001b90
크게 3번 호출됨
FUN_140001b90(puVar6,(uint *)local_68,0x40,param_4);
FUN_140001b90(puVar6,(uint *)local_88,0x20,param_4);
FUN_140001b90(puVar6,(uint *)local_88,0x20,param_4);

0. srand(current time)
1. chacha20 컨텍스트를 16개 생성 (rand() 기반 초기화)
2. local_68에 0x40 bytes chacha20 stream 생성
3. local_88에 0x20 bytes 생성
4. local_68에 local_88을 xor
5. local_88에 0x20 bytes 생성
6. local_48에 local_88을 xor
7. 3-6을 컨텍스트마다 반복 (16번)
8. 최종적으로 64B 배열 arr가 나옴
9. 입력 그림을 읽으면서 각 바이트에 xor with arr[rand() % 64] 적용

FUN_140001670 에서 내부 state 세팅하고 memcpy를 해간다

+0x48~ 은 아직 출력되지 않은 keystream의 버퍼로 보인다.

20f0 알고리즘
expand && 0으로 초기화된 고뎅서 0x28-byte를 뽑는다.
xor with random 0x28 string
fill key (8 blocks after cons)  with the first 0x20 of 0x28 string
set counter to 0
set nounce to 0, last of 0x28 string



puVar6[0] after 1070 call
0000021FB3D10040  65 78 70 61 6E 64 20 33 32 2D 62 79 74 65 20 6B  expand 32-byte k  
0000021FB3D10050  95 26 30 FD 2F 0F 0E 68 50 75 3F C9 ED 94 E7 B8  .&0ý/..hPu?Éí.ç¸  
0000021FB3D10060  EB A4 56 B8 E7 31 B0 4A AA 4C B4 F0 CE 3F 39 E7  ë¤V¸ç1°JªL´ðÎ?9ç  
0000021FB3D10070  01 00 00 00 00 00 00 00 6D 93 56 E8 D0 5B 39 9D  ........m.VèÐ[9.  
0000021FB3D10080  00 00 00 00 00 00 00 00 73 F1 5E A5 F3 B0 6D B3  ........sñ^¥ó°m³  
0000021FB3D10090  34 49 9C BD 7D 62 5F 02 88 16 2B 3D 80 C6 97 A6  4I.½}b_...+=.Æ.¦  
0000021FB3D100A0  9C 3F 5C C2 3D A4 35 27 EF 19 BB 23 74 BE 71 80  .?\Â=¤5'ï.»#t¾q.  
0000021FB3D100B0  F5 B2 47 64 5A D3 51 20 1C 98 59 EF C5 C3 5B 1E  õ²GdZÓQ ..YïÅÃ[.  
0000021FB3D100C0  38 00 00 00 08 00 00 00 14 00 00 00 00 00 00 00  8...............  
0000021FB3D100D0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
0000021FB3D100E0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
0000021FB3D100F0  00 00 00 00 00 00 00 00 01 00 00 00 65 78 70 61  ............expa

0x2f int 씩 건너뜀 (i.e., block size)

puVar6[0] after first 140001b90 call (64B)
0000021FB3D10040  65 78 70 61 6E 64 20 33 32 2D 62 79 74 65 20 6B  expand 32-byte k  
0000021FB3D10050  95 26 30 FD 2F 0F 0E 68 50 75 3F C9 ED 94 E7 B8  .&0ý/..hPu?Éí.ç¸  
0000021FB3D10060  EB A4 56 B8 E7 31 B0 4A AA 4C B4 F0 CE 3F 39 E7  ë¤V¸ç1°JªL´ðÎ?9ç  
0000021FB3D10070  02 00 00 00 00 00 00 00 6D 93 56 E8 D0 5B 39 9D  ........m.VèÐ[9.  
0000021FB3D10080  00 00 00 00 00 00 00 00 38 61 60 D6 68 84 A0 BB  ........8a`Öh. »  
0000021FB3D10090  E4 4A 05 1F F9 7A FF 6E 08 78 01 06 C9 19 1D 16  äJ..ùzÿn.x..É...  
0000021FB3D100A0  1D 35 3A 9F C4 92 6F 2C 83 0C 7F 4F 91 AC 06 BD  .5:.Ä.o,...O.¬.½  
0000021FB3D100B0  ED 59 4A D6 88 37 FE E7 8A E6 83 4C F4 D9 AB F0  íYJÖ.7þç.æ.LôÙ«ð  
0000021FB3D100C0  38 00 00 00 08 00 00 00 14 00 00 00 00 00 00 00  8...............  
0000021FB3D100D0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
0000021FB3D100E0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
0000021FB3D100F0  00 00 00 00 00 00 00 00 01 00 00 00 65 78 70 61  ............expa  

stream generated by first call
000000B78A18F830  73 F1 5E A5 F3 B0 6D B3 34 49 9C BD 7D 62 5F 02  sñ^¥ó°m³4I.½}b_.  
000000B78A18F840  88 16 2B 3D 80 C6 97 A6 9C 3F 5C C2 3D A4 35 27  ..+=.Æ.¦.?\Â=¤5'  
000000B78A18F850  EF 19 BB 23 74 BE 71 80 F5 B2 47 64 5A D3 51 20  ï.»#t¾q.õ²GdZÓQ   
000000B78A18F860  1C 98 59 EF C5 C3 5B 1E 48 BF 99 BD 28 FB BA E6  ..YïÅÃ[.H¿.½(ûºæ  

puVar6[0] after second 140001b90 call (32B)
000001EFB8727040  65 78 70 61 6E 64 20 33 32 2D 62 79 74 65 20 6B  expand 32-byte k  
000001EFB8727050  95 26 30 FD 2F 0F 0E 68 50 75 3F C9 ED 94 E7 B8  .&0ý/..hPu?Éí.ç¸  
000001EFB8727060  EB A4 56 B8 E7 31 B0 4A AA 4C B4 F0 CE 3F 39 E7  ë¤V¸ç1°JªL´ðÎ?9ç  
000001EFB8727070  02 00 00 00 00 00 00 00 6D 93 56 E8 D0 5B 39 9D  ........m.VèÐ[9.  
000001EFB8727080  00 00 00 00 00 00 00 00 38 61 60 D6 68 84 A0 BB  ........8a`Öh. »  
000001EFB8727090  E4 4A 05 1F F9 7A FF 6E 08 78 01 06 C9 19 1D 16  äJ..ùzÿn.x..É...  
000001EFB87270A0  1D 35 3A 9F C4 92 6F 2C 83 0C 7F 4F 91 AC 06 BD  .5:.Ä.o,...O.¬.½  
000001EFB87270B0  ED 59 4A D6 88 37 FE E7 8A E6 83 4C F4 D9 AB F0  íYJÖ.7þç.æ.LôÙ«ð  
000001EFB87270C0  18 00 00 00 08 00 00 00 14 00 00 00 00 00 00 00  ................  
000001EFB87270D0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
000001EFB87270E0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
000001EFB87270F0  00 00 00 00 00 00 00 00 01 00 00 00 65 78 70 61  ............expa  

stream generated by second call
000000B78A18F810  38 61 60 D6 68 84 A0 BB E4 4A 05 1F F9 7A FF 6E  8a`Öh. »äJ..ùzÿn  
000000B78A18F820  08 78 01 06 C9 19 1D 16 1D 35 3A 9F C4 92 6F 2C  .x..É....5:.Ä.o,  

puVar6[0] after third 140001b90 call (32B)
000001E02DCB8040  65 78 70 61 6E 64 20 33 32 2D 62 79 74 65 20 6B  expand 32-byte k  
000001E02DCB8050  95 26 30 FD 2F 0F 0E 68 50 75 3F C9 ED 94 E7 B8  .&0ý/..hPu?Éí.ç¸  
000001E02DCB8060  EB A4 56 B8 E7 31 B0 4A AA 4C B4 F0 CE 3F 39 E7  ë¤V¸ç1°JªL´ðÎ?9ç  
000001E02DCB8070  03 00 00 00 00 00 00 00 6D 93 56 E8 D0 5B 39 9D  ........m.VèÐ[9.  
000001E02DCB8080  00 00 00 00 00 00 00 00 21 DA 4B F9 0F F9 36 92  ........!ÚKù.ù6.  
000001E02DCB8090  F2 63 A1 03 73 EF 8A 4E A4 B7 31 6F DE 9B C1 17  òc¡.sï.N¤·1oÞ.Á.  
000001E02DCB80A0  67 78 A8 BA 7D 1B 4A 09 57 82 A4 A1 BD 2B E1 E6  gx¨º}.J.W.¤¡½+áæ  
000001E02DCB80B0  CE 50 66 6E A4 C3 63 C6 3F AE 52 56 A1 F1 C1 41  ÎPfn¤ÃcÆ?®RV¡ñÁA  
000001E02DCB80C0  38 00 00 00 08 00 00 00 14 00 00 00 00 00 00 00  8...............  
000001E02DCB80D0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
000001E02DCB80E0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
000001E02DCB80F0  00 00 00 00 00 00 00 00 01 00 00 00 65 78 70 61  ............expa  

stream generated by third call
000000B78A18F810  83 0C 7F 4F 91 AC 06 BD ED 59 4A D6 88 37 FE E7  ...O.¬.½íYJÖ.7þç  
000000B78A18F820  8A E6 83 4C F4 D9 AB F0 04 EE 9C 22 2D EF E4 D3  .æ.LôÙ«ð.î."-ïäÓ  

srand(42); sequence
AF
190
45CD
7568
3ED3

state after calling 1b90 inside 20f0
00000278B93E4040  65 78 70 61 6E 64 20 33 32 2D 62 79 74 65 20 6B  expand 32-byte k  
00000278B93E4050  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
00000278B93E4060  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
00000278B93E4070  01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
00000278B93E4080  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
00000278B93E4090  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
00000278B93E40A0  00 00 00 00 00 00 00 00 77 24 E0 3F B8 D8 4A 37  ........w$à?¸ØJ7  
00000278B93E40B0  6A 43 B8 F4 15 18 A1 1C C3 87 B6 69 B2 EE 65 86  jC¸ô..¡.Ã.¶i²îe.  
00000278B93E40C0  18 00 00 00 08 00 00 00 14 00 00 00 00 00 00 00  ................  
00000278B93E40D0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
00000278B93E40E0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
00000278B93E40F0  00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00  ................  

state after calling 20f0 inside 1070
000002A206E90040  65 78 70 61 6E 64 20 33 32 2D 62 79 74 65 20 6B  expand 32-byte k  
000002A206E90050  95 26 30 FD 2F 0F 0E 68 50 75 3F C9 ED 94 E7 B8  .&0ý/..hPu?Éí.ç¸  
000002A206E90060  EB A4 56 B8 E7 31 B0 4A AA 4C B4 F0 CE 3F 39 E7  ë¤V¸ç1°JªL´ðÎ?9ç  
000002A206E90070  00 00 00 00 00 00 00 00 6D 93 56 E8 D0 5B 39 9D  ........m.VèÐ[9.  
000002A206E90080  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
000002A206E90090  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
000002A206E900A0  00 00 00 00 00 00 00 00 77 24 E0 3F B8 D8 4A 37  ........w$à?¸ØJ7  
000002A206E900B0  6A 43 B8 F4 15 18 A1 1C C3 87 B6 69 B2 EE 65 86  jC¸ô..¡.Ã.¶i²îe.  
000002A206E900C0  00 00 00 00 08 00 00 00 14 00 00 00 00 00 00 00  ................  
000002A206E900D0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
000002A206E900E0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................  
000002A206E900F0  00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00  ................  

do {
  iVar7 = rand();
  cVar2 = (char)iVar8;
  iVar8 = iVar8 + 1;
  *pbVar9 = (char)iVar7 * (cVar2 + '\x01' + *(char *)param_2);
  pbVar9 = pbVar9 + 1;
} while (iVar8 < 0x28);
FUN_1400020f0(local_58,0x28,param_1);
iVar7 = rand();
_Memory = (undefined8 *)malloc((longlong)(iVar7 % 0x100 + 9));
if ((_Memory != (undefined8 *)0x0) && (*(short *)(param_1 + 0x2e) != 0)) {
  *_Memory = 0;
  FUN_140001b90(param_1,(uint *)_Memory,8,(uint *)_Memory);
}
free(_Memory);


lVar5 = 0x28;
local_18 = 0;
local_38 = ZEXT816(0);
local_28 = ZEXT816(0);
iVar2 = FUN_140001b90(param_3,(uint *)local_38,0x28,(uint *)local_38);
if (iVar2 == 0) {
  uVar8 = 0;
  if (param_2 != 0) {
    uVar7 = (ulonglong)param_2;
    uVar6 = uVar8;
    do {
      local_38[uVar6 % 0x28] = local_38[uVar6 % 0x28] ^ *param_1;
      uVar7 = uVar7 - 1;
      param_1 = param_1 + 1;
      uVar6 = uVar6 + 1;
    } while (uVar7 != 0);
  }
  uVar3 = FUN_140001ea0(param_3,(undefined4 *)local_38);
  if ((int)uVar3 == 0) {
    *(ulonglong *)(param_3 + 0xc) = uVar8;
    param_3[0x20] = (uint)uVar8;
    param_3[0x21] = 8;
    param_3[0xe] = (uint)local_18;
    puVar4 = local_38;
    param_3[0xf] = (uint)((ulonglong)local_18 >> 0x20);
    do {
      *puVar4 = (char)uVar8;
      puVar4 = puVar4 + 1;
      lVar5 = lVar5 + -1;
    } while (lVar5 != 0);
  }
}
